kind: Cluster
name: k8s-scots-lab
kubernetes:
  version: v1.34.3
talos:
  version: v1.11.5
features:
  diskEncryption: true
  enableWorkloadProxy: true
  useEmbeddedDiscoveryService: true
patches:
  - name: clusterconfig
    inline:
      cluster:
        allowSchedulingOnControlPlanes: true
        apiServer:
          admissionControl:
            - name: PodSecurity
              configuration:
                exemptions:
                  namespaces:
                    - rook-ceph
          extraArgs:
            feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true,ImageVolume=true
        controllerManager:
          extraArgs:
            feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true,ImageVolume=true
        scheduler:
          extraArgs:
            feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true,ImageVolume=true
        network:
          cni:
            name: none
        proxy:
          disabled: true
  - name: machinepatch
    inline:
      machine:
        kubelet:
          extraArgs:
            max-pods: "250"
            feature-gates: UserNamespacesSupport=true,UserNamespacesPodSecurityStandards=true,ImageVolume=true
          extraConfig:
            shutdownGracePeriod: "600s"
            shutdownGracePeriodCriticalPods: "120s"
        registries:
          config:
            git.somostechs.com:
              tls:
                insecureSkipVerify: true
        features:
          hostDNS:
            enabled: true
            forwardKubeDNSToHost: false              
        sysctls:
          user.max_user_namespaces: "11255"
  - name: extramanifests
    file: bootstrap/k8s-cluster-extramanifests.yaml
  - name: extramanifests-multus
    file: bootstrap/k8s-cluster-extramanifests-multus.yaml
  - name: extramanifests-cilium
    file: bootstrap/k8s-cluster-extramanifests-cilium.yaml
  - name: extramanifests-gateway-api-crds
    file: bootstrap/k8s-cluster-extramanifests-gateway-api-crds.yaml    
  - name: extramanifests-argocd
    file: bootstrap/k8s-cluster-extramanifests-argocd.yaml
  - name: extramanifests-argocd-projects
    file: bootstrap/k8s-cluster-extramanifests-argocd-projects.yaml
  - name: extramanifests-argocd-apps
    file: bootstrap/k8s-cluster-extramanifests-argocd-apps.yaml

---
kind: ControlPlane
machineClass:
  name: scots-lab
  size: 3
patches:
  - name: machinepatch
    inline:
      machine:
        install:
          extraKernelArgs:
            - ipv6.disable=1
        kernel:
          modules:
            - name: nbd             

---
kind: Workers
machineClass:
  name: scots-lab
  size: 0